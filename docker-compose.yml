version: "3.9"

services:
  app:
    image: php:8.2-apache
    container_name: laporwarga_app
    restart: always
    ports:
      - "80:80"
    volumes:
      - .:/var/www/html
    environment:
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - APP_ENV=${APP_ENV}
      - APP_DEBUG=${APP_DEBUG}
    depends_on:
      - db
    command: >
      bash -c "
      docker-php-ext-install pdo pdo_mysql mysqli &&
      apt-get update &&
      apt-get install -y libcurl4-openssl-dev pkg-config libssl-dev &&
      docker-php-ext-install curl &&
      a2enmod rewrite &&
      echo 'ServerName localhost' >> /etc/apache2/apache2.conf &&
      echo '<VirtualHost *:80>' > /etc/apache2/sites-available/000-default.conf &&
      echo '    DocumentRoot /var/www/html' >> /etc/apache2/sites-available/000-default.conf &&
      echo '    <Directory /var/www/html>' >> /etc/apache2/sites-available/000-default.conf &&
      echo '        Options Indexes FollowSymLinks' >> /etc/apache2/sites-available/000-default.conf &&
      echo '        AllowOverride All' >> /etc/apache2/sites-available/000-default.conf &&
      echo '        Require all granted' >> /etc/apache2/sites-available/000-default.conf &&
      echo '    </Directory>' >> /etc/apache2/sites-available/000-default.conf &&
      echo '    <Directory /var/www/html/public>' >> /etc/apache2/sites-available/000-default.conf &&
      echo '        DirectoryIndex index.php' >> /etc/apache2/sites-available/000-default.conf &&
      echo '    </Directory>' >> /etc/apache2/sites-available/000-default.conf &&
      echo '    <Directory /var/www/html/uploads>' >> /etc/apache2/sites-available/000-default.conf &&
      echo '        Options -Indexes' >> /etc/apache2/sites-available/000-default.conf &&
      echo '    </Directory>' >> /etc/apache2/sites-available/000-default.conf &&
      echo '    ErrorLog /var/log/apache2/error.log' >> /etc/apache2/sites-available/000-default.conf &&
      echo '    CustomLog /var/log/apache2/access.log combined' >> /etc/apache2/sites-available/000-default.conf &&
      echo '</VirtualHost>' >> /etc/apache2/sites-available/000-default.conf &&
      chown -R www-data:www-data /var/www/html/uploads &&
      chmod -R 755 /var/www/html/uploads &&
      apache2-foreground
      "

  db:
    image: mysql:8.0
    container_name: laporwarga_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    # Port MySQL TIDAK exposed ke internet (hanya internal Docker network)
    # ports:
    #   - "3306:3306"

volumes:
  db_data:
